---
import { Icon } from "astro-icon/components";
import { siteConfig } from "../config";
import { softwareData } from "../data/devices";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";

export const prerender = true;

if (!siteConfig.featurePages.devices) {
	return Astro.redirect("/404/");
}

const softwareByCategory = softwareData;
const categories = Object.keys(softwareByCategory);
---

<MainGridLayout title={i18n(I18nKey.devices)}>
	<script>
		import("../scripts/right-sidebar-layout.js");
	</script>

	<div
		class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32"
	>
		<div class="card-base z-10 px-9 py-6 relative w-full">
			<div class="flex flex-col items-start justify-center mb-8">
				<h1
					class="text-4xl font-bold text-black/90 dark:text-white/90 mb-2 relative before:w-1 before:h-8 before:rounded-md before:bg-[var(--primary)] before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4"
				>
					{i18n(I18nKey.devices)}
				</h1>
				<p class="text-lg text-black/60 dark:text-white/60">
					{i18n(I18nKey.devicesSubtitle)}
				</p>
			</div>

			<div class="mb-6">
				<div class="filter-container flex flex-wrap gap-2">
					{
						categories.map((category, index) => (
							<button
								data-category={category}
								class={`filter-tag px-6 py-2.5 rounded-lg font-medium transition-all ${
									index === 0 ? "active" : ""
								}`}
							>
								{category}
							</button>
						))
					}
				</div>
			</div>

			<div
				id="software-container"
				class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 items-stretch"
			>
				{
					softwareByCategory[categories[0]].map((software, index) => (
						<a
							href={software.link}
							target="_blank"
							rel="noopener noreferrer"
							class="software-card group relative overflow-hidden rounded-xl border border-[var(--line-divider)] bg-[var(--card-bg)] transition-all duration-300 hover:border-[var(--primary)]/50 hover:shadow-md hover:shadow-black/5 dark:hover:shadow-white/5 hover:scale-[1.01] block cursor-pointer"
							style={`animation-delay: ${index * 80}ms`}
						>
								<div class="p-4">
									<div class="flex items-start gap-3">
										<div class="software-avatar w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-[var(--btn-regular-bg)] border border-[var(--line-divider)] overflow-hidden flex items-center justify-center shrink-0">
											<img
												src={software.image}
												alt={software.name}
												loading="lazy"
												class="w-3/4 h-3/4 object-contain"
											/>
										</div>
										<div class="min-w-0 flex flex-col">
											<h3 class="text-base font-bold text-black/90 dark:text-white/90 group-hover:text-[var(--primary)] transition-colors duration-300 leading-snug truncate">
												{software.name}
											</h3>
											<p class="text-sm text-black/60 dark:text-white/60 truncate">
												{software.specs}
											</p>
										</div>
									</div>
									<div class="mt-3 border-t border-[var(--line-divider)] border-dashed"></div>
									<p class="mt-3 text-sm text-black/60 dark:text-white/60 leading-relaxed line-clamp-2">
										{software.description}
									</p>
								</div>
						</a>
					))
				}
			</div>
		</div>
	</div>

	<script is:inline define:vars={{ softwareByCategory }}>
		const categoryTabs = document.querySelectorAll(".filter-tag");
		const softwareContainer = document.getElementById("software-container");

		let resizeTimer;

		const syncCardHeights = () => {
			const softwareCards = Array.from(
				document.querySelectorAll(".software-card"),
			);
			if (!softwareCards.length) return;

			softwareCards.forEach((card) => {
				card.style.minHeight = "";
			});

			const maxHeight = Math.max(
				...softwareCards.map(
					(card) => card.getBoundingClientRect().height,
				),
			);
			softwareCards.forEach((card) => {
				card.style.minHeight = `${Math.ceil(maxHeight)}px`;
			});
		};

		const bindImageLoad = () => {
			const images = softwareContainer?.querySelectorAll("img") ?? [];
			images.forEach((image) => {
				if (!image.complete) {
					image.addEventListener("load", syncCardHeights, {
						once: true,
					});
				}
			});
		};

		const renderCategory = (category) => {
			const categorySoftware = softwareByCategory[category] || [];
			softwareContainer.innerHTML = categorySoftware
				.map(
					(software, index) => `
						<a
							href="${software.link}"
							target="_blank"
							rel="noopener noreferrer"
							class="software-card group relative overflow-hidden rounded-xl border border-[var(--line-divider)] bg-[var(--card-bg)] transition-all duration-300 hover:border-[var(--primary)]/50 hover:shadow-md hover:shadow-black/5 dark:hover:shadow-white/5 hover:scale-[1.01] block cursor-pointer"
							style="animation-delay: ${index * 80}ms; animation: fadeInUp 0.45s cubic-bezier(0.25, 0.1, 0.25, 1) forwards; opacity: 0;"
						>
								<div class="p-4">
									<div class="flex items-start gap-3">
										<div class="software-avatar w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-[var(--btn-regular-bg)] border border-[var(--line-divider)] overflow-hidden flex items-center justify-center shrink-0">
											<img
												src="${software.image}"
												alt="${software.name}"
												loading="lazy"
												class="w-3/4 h-3/4 object-contain"
											/>
										</div>
										<div class="min-w-0 flex flex-col">
											<h3 class="text-base font-bold text-black/90 dark:text-white/90 group-hover:text-[var(--primary)] transition-colors duration-300 leading-snug truncate">
												${software.name}
											</h3>
											<p class="text-sm text-black/60 dark:text-white/60 truncate">
												${software.specs}
											</p>
										</div>
									</div>
									<div class="mt-3 border-t border-[var(--line-divider)] border-dashed"></div>
									<p class="mt-3 text-sm text-black/60 dark:text-white/60 leading-relaxed line-clamp-2">
										${software.description}
									</p>
								</div>
						</a>
					`,
				)
				.join("");

			bindImageLoad();
			syncCardHeights();
		};

		categoryTabs.forEach((tab) => {
			tab.addEventListener("click", () => {
				const category = tab.dataset.category;
				if (!category) return;

				categoryTabs.forEach((item) => item.classList.remove("active"));
				tab.classList.add("active");
				renderCategory(category);
			});
		});

		window.addEventListener("resize", () => {
			clearTimeout(resizeTimer);
			resizeTimer = setTimeout(syncCardHeights, 120);
		});

		bindImageLoad();
		syncCardHeights();
	</script>

	<style>
		.filter-container {
			display: flex;
			flex-wrap: wrap;
			gap: 0.75rem;
			margin-bottom: 1rem;
		}

		.filter-tag {
			padding: 0.625rem 1.25rem;
			border: 1px solid var(--line-divider);
			border-radius: var(--radius-large);
			background: var(--btn-regular-bg);
			color: var(--btn-content);
			font-size: 0.875rem;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			white-space: nowrap;
			position: relative;
			overflow: hidden;
		}

		.filter-tag::before {
			content: "";
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: var(--primary);
			opacity: 0;
			transition: opacity 0.3s ease;
			z-index: -1;
		}

		.filter-tag:hover:not(.active) {
			background: var(--btn-hover-bg);
			border-color: var(--primary);
			transform: translateY(-2px);
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		}

		.filter-tag.active {
			background: var(--primary);
			color: #fff;
			border-color: var(--primary);
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(var(--color-primary-rgb), 0.3);
		}

		.filter-tag.active:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 16px rgba(var(--color-primary-rgb), 0.4);
		}

		@keyframes fadeInUp {
			from {
				opacity: 0;
				transform: translateY(20px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.line-clamp-2 {
			display: -webkit-box;
			-webkit-line-clamp: 2;
			-webkit-box-orient: vertical;
			overflow: hidden;
		}

		.software-card::after {
			content: "";
			position: absolute;
			inset: 0;
			border-radius: 0.75rem;
			background: linear-gradient(
				135deg,
				rgba(var(--color-primary-rgb), 0.05),
				transparent
			);
			opacity: 0;
			transition: opacity 0.4s ease;
			pointer-events: none;
		}

		.software-card:hover::after {
			opacity: 1;
		}

		.software-card h3 {
			text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
		}

		@media (max-width: 640px) {
			.filter-container {
				gap: 0.5rem;
			}

			.filter-tag {
				padding: 0.5rem 1rem;
				font-size: 0.8rem;
			}

			.software-card .p-4 {
				padding: 0.75rem;
			}
}

		@media (prefers-color-scheme: dark) {
			.software-card:hover {
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
			}
		}
	</style>
</MainGridLayout>
