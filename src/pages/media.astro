---
import ImageWrapper from "../components/misc/ImageWrapper.astro";
import { siteConfig } from "../config";
import localBookList from "../data/books";
import localMovieList from "../data/movies";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";
import "../styles/anime.css";

if (!siteConfig.featurePages.books && !siteConfig.featurePages.movies) {
	return Astro.redirect("/404/");
}

function getBookStatusInfo(status: string) {
	switch (status) {
		case "reading":
			return {
				text: i18n(I18nKey.bookStatusReading),
				class: "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300",
				icon: "üìñ",
			};
		case "completed":
			return {
				text: i18n(I18nKey.bookStatusCompleted),
				class: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300",
				icon: "‚úì",
			};
		case "planned":
			return {
				text: i18n(I18nKey.bookStatusPlanned),
				class: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300",
				icon: "‚ù§",
			};
		default:
			return {
				text: status,
				class: "bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300",
				icon: "?",
			};
	}
}

function getMovieStatusInfo(status: string) {
	switch (status) {
		case "watched":
			return {
				text: i18n(I18nKey.movieStatusWatched),
				class: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300",
				icon: "‚úì",
			};
		case "watching":
			return {
				text: i18n(I18nKey.movieStatusWatching),
				class: "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300",
				icon: "‚ñ∂",
			};
		case "planned":
			return {
				text: i18n(I18nKey.movieStatusPlanned),
				class: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300",
				icon: "‚ù§",
			};
		default:
			return {
				text: status,
				class: "bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300",
				icon: "?",
			};
	}
}

// ÊáíÂä†ËΩΩÈÖçÁΩÆ - Â∑≤Á¶ÅÁî®ÔºåÊòæÁ§∫ÊâÄÊúâÂÜÖÂÆπ
const visibleBookList = localBookList;
const visibleMovieList = localMovieList;

// ËÆ°ÁÆóÂêÑÁä∂ÊÄÅÊï∞Èáè
const bookCounts = {
	all: localBookList.length,
	reading: localBookList.filter((b) => b.status === "reading").length,
	planned: localBookList.filter((b) => b.status === "planned").length,
	completed: localBookList.filter((b) => b.status === "completed").length,
};

const movieCounts = {
	all: localMovieList.length,
	watched: localMovieList.filter((m) => m.status === "watched").length,
	watching: localMovieList.filter((m) => m.status === "watching").length,
	planned: localMovieList.filter((m) => m.status === "planned").length,
};
---

<MainGridLayout title="ÊàëÁöÑ‰π¶ÂΩ±Èü≥" description="ËÆ∞ÂΩïÊàëÁöÑÈòÖËØª‰∏éËßÇÂΩ±‰πãÊóÖ">
	<div
		class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32"
	>
		<div class="card-base anime-card-base z-10 px-9 py-6 relative w-full">
			<div class="relative w-full mb-8">
				<div class="mb-6 flex justify-between items-start">
					<div>
						<h1
							class="text-4xl font-bold text-black/90 dark:text-white/90 mb-2 relative before:w-1 before:h-8 before:rounded-md before:bg-[var(--primary)] before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4"
							id="page-title"
						>
							{i18n(I18nKey.bookTitle)}
						</h1>
						<p
							class="text-black/75 dark:text-white/75"
							id="page-subtitle"
						>
							{i18n(I18nKey.bookSubtitle)}
						</p>
					</div>
					<div class="flex gap-2">
						<button
							id="btn-books"
							class="media-type-btn media-type-active px-4 py-2 rounded-lg font-medium transition-all flex items-center gap-2"
							data-type="books"
						>
							<span class="text-lg">üìö</span>
							<span>‰π¶Á±ç</span>
						</button>
						<button
							id="btn-movies"
							class="media-type-btn px-4 py-2 rounded-lg font-medium transition-all flex items-center gap-2"
							data-type="movies"
						>
							<span class="text-lg">üé¨</span>
							<span>ÁîµÂΩ±</span>
						</button>
					</div>
				</div>

				<div class="mb-6" id="book-filters">
					<div class="anime-filter-container flex flex-wrap gap-2">
						<button
							class="anime-filter-tag anime-active"
							data-status="all"
							>{i18n(I18nKey.bookFilterAll)} ({
								bookCounts.all
							})</button
						>
						<button class="anime-filter-tag" data-status="reading"
							>{i18n(I18nKey.bookStatusReading)} ({
								bookCounts.reading
							})</button
						>
						<button class="anime-filter-tag" data-status="planned"
							>{i18n(I18nKey.bookStatusPlanned)} ({
								bookCounts.planned
							})</button
						>
						<button class="anime-filter-tag" data-status="completed"
							>{i18n(I18nKey.bookStatusCompleted)} ({
								bookCounts.completed
							})</button
						>
					</div>
				</div>

				<div class="mb-6 hidden" id="movie-filters">
					<div class="anime-filter-container flex flex-wrap gap-2">
						<button
							class="anime-filter-tag anime-active"
							data-status="all"
							>{i18n(I18nKey.movieFilterAll)} ({
								movieCounts.all
							})</button
						>
						<button class="anime-filter-tag" data-status="watched"
							>{i18n(I18nKey.movieStatusWatched)} ({
								movieCounts.watched
							})</button
						>
						<button class="anime-filter-tag" data-status="watching"
							>{i18n(I18nKey.movieStatusWatching)} ({
								movieCounts.watching
							})</button
						>
						<button class="anime-filter-tag" data-status="planned"
							>{i18n(I18nKey.movieStatusPlanned)} ({
								movieCounts.planned
							})</button
						>
					</div>
				</div>
			</div>

			<div class="mb-8">
				<div
					id="books-container"
					class="anime-grid-container anime-list-mode grid gap-4 md:gap-6"
				>
					{
						visibleBookList.map((book) => {
							const statusInfo = getBookStatusInfo(book.status);
							const progressPercent =
								book.totalPages &&
								book.totalPages > 0 &&
								book.progress
									? (book.progress / book.totalPages) * 100
									: 0;
							return (
								<div
									class="group relative bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-[var(--radius-large)] overflow-hidden hover:shadow-lg transition-all duration-300 book-item"
									data-anime-status={book.status}
								>
									<div class="flex gap-4 p-4">
										<div class="relative flex-shrink-0 w-24 h-32 overflow-hidden rounded-lg">
											<a
												href={`https://book.douban.com/subject/${book.doubanId}/`}
												target="_blank"
												rel="noopener noreferrer"
												class="block w-full h-full"
											>
												<ImageWrapper
													src="/assets/books/chongfan.jpg"
													alt="Book Cover"
													class="w-full h-full object-cover transition-transform duration-200 group-hover:scale-105"
												/>
											</a>
											<div
												class={`absolute top-1 left-1 px-1.5 py-0.5 rounded text-xs font-medium ${statusInfo.class}`}
											>
												<span class="mr-0.5">
													{statusInfo.icon}
												</span>
											</div>
										</div>

										<div class="flex-1 flex flex-col min-w-0">
											<div class="flex items-start justify-between gap-2 mb-2">
												<h3 class="text-lg font-bold text-black/90 dark:text-white/90 leading-tight line-clamp-1 flex-1">
													{book.title ||
														`Ë±ÜÁì£ID: ${book.doubanId}`}
												</h3>
												{book.rating && (
													<div class="flex items-center gap-1 text-sm text-amber-500 flex-shrink-0">
														<span>‚≠ê</span>
														<span class="font-semibold">
															{book.rating}
														</span>
													</div>
												)}
											</div>

											{book.author && (
												<p class="text-black/60 dark:text-white/60 text-sm mb-2">
													{book.author}
												</p>
											)}

											{book.description && (
												<p class="text-black/70 dark:text-white/70 text-xs leading-relaxed line-clamp-2 mb-3 flex-1">
													{book.description}
												</p>
											)}

											<div class="flex items-center gap-2 mt-auto">
												{book.genre &&
													book.genre.length > 0 && (
														<div class="flex flex-wrap gap-1.5">
															{book.genre
																.slice(0, 3)
																.map((g) => (
																	<span class="px-2 py-0.5 bg-[var(--primary)]/10 text-[var(--primary)] rounded text-xs">
																		{g}
																	</span>
																))}
														</div>
													)}
											</div>

											{book.status === "reading" &&
												book.totalPages &&
												book.totalPages > 0 &&
												book.progress && (
													<div class="mt-3 pt-3 border-t border-[var(--line-divider)]">
														<div class="flex items-center justify-between mb-1.5">
															<span class="text-xs text-black/60 dark:text-white/60">
																ÈòÖËØªËøõÂ∫¶
															</span>
															<span class="text-xs font-medium text-black/80 dark:text-white/80">
																{book.progress}/
																{
																	book.totalPages
																}{" "}
																È°µ (
																{Math.round(
																	progressPercent,
																)}
																%)
															</span>
														</div>
														<div class="w-full bg-black/5 dark:bg-white/10 rounded-full h-1.5">
															<div
																class="bg-gradient-to-r from-emerald-400 to-teal-400 h-1.5 rounded-full transition-all duration-300"
																style={`width: ${progressPercent}%`}
															/>
														</div>
													</div>
												)}
										</div>
									</div>
								</div>
							);
						})
					}
				</div>

				<div
					id="movies-container"
					class="anime-grid-container anime-list-mode grid gap-4 md:gap-6 hidden"
				>
					{
						visibleMovieList.map((movie) => {
							const statusInfo = getMovieStatusInfo(movie.status);
							return (
								<div
									class="group relative bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-[var(--radius-large)] overflow-hidden hover:shadow-lg transition-all duration-300 movie-item"
									data-anime-status={movie.status}
								>
									<div class="flex gap-4 p-4">
										<div class="relative flex-shrink-0 w-24 h-32 overflow-hidden rounded-lg">
											<a
												href={`https://movie.douban.com/subject/${movie.doubanId}/`}
												target="_blank"
												rel="noopener noreferrer"
												class="block w-full h-full"
											>
												<ImageWrapper
													src="/assets/movies/Interstellar.webp"
													alt="Movie Poster"
													class="w-full h-full object-cover transition-transform duration-200 group-hover:scale-105"
												/>
											</a>
											<div
												class={`absolute top-1 left-1 px-1.5 py-0.5 rounded text-xs font-medium ${statusInfo.class}`}
											>
												<span class="mr-0.5">
													{statusInfo.icon}
												</span>
											</div>
										</div>

										<div class="flex-1 flex flex-col min-w-0">
											<div class="flex items-start justify-between gap-2 mb-2">
												<h3 class="text-lg font-bold text-black/90 dark:text-white/90 leading-tight line-clamp-1 flex-1">
													{movie.title ||
														`Ë±ÜÁì£ID: ${movie.doubanId}`}
												</h3>
												{movie.rating && (
													<div class="flex items-center gap-1 text-sm text-amber-500 flex-shrink-0">
														<span>‚≠ê</span>
														<span class="font-semibold">
															{movie.rating}
														</span>
													</div>
												)}
											</div>

											{movie.director && (
												<p class="text-black/60 dark:text-white/60 text-sm mb-2">
													ÂØºÊºî: {movie.director}
												</p>
											)}

											{movie.description && (
												<p class="text-black/70 dark:text-white/70 text-xs leading-relaxed line-clamp-2 mb-3 flex-1">
													{movie.description}
												</p>
											)}

											<div class="flex items-center justify-between gap-2 mt-auto">
												{movie.genre &&
													movie.genre.length > 0 && (
														<div class="flex flex-wrap gap-1.5">
															{movie.genre
																.slice(0, 3)
																.map((g) => (
																	<span class="px-2 py-0.5 bg-[var(--primary)]/10 text-[var(--primary)] rounded text-xs">
																		{g}
																	</span>
																))}
														</div>
													)}
												{movie.year && (
													<span class="text-xs text-black/50 dark:text-white/50 flex-shrink-0">
														{movie.year}
													</span>
												)}
											</div>
										</div>
									</div>
								</div>
							);
						})
					}
				</div>
			</div>
		</div>
	</div>

	<style>
		.media-type-btn {
			background: var(--btn-regular-bg);
			color: var(--btn-content);
			border: 1px solid var(--line-divider);
		}
		.media-type-btn:hover:not(.media-type-active) {
			background: var(--btn-hover-bg);
			border-color: var(--primary);
			transform: translateY(-1px);
		}
		.media-type-btn.media-type-active {
			background: var(--primary);
			color: white;
			border-color: var(--primary);
		}

		/* Á°Æ‰øùÈöêËóèÊ†∑ÂºèÁîüÊïà */
		#books-container.hidden,
		#movies-container.hidden {
			display: none !important;
		}
	</style>

	<script is:inline>
		(function () {
			let initialized = false;

			function initMediaPage() {
				// Èò≤Ê≠¢ÈáçÂ§çÂàùÂßãÂåñ
				if (initialized) return;

				const btnBooks = document.getElementById("btn-books");
				const btnMovies = document.getElementById("btn-movies");
				const booksContainer =
					document.getElementById("books-container");
				const moviesContainer =
					document.getElementById("movies-container");
				const bookFilters = document.getElementById("book-filters");
				const movieFilters = document.getElementById("movie-filters");
				const pageTitle = document.getElementById("page-title");
				const pageSubtitle = document.getElementById("page-subtitle");

				if (
					!btnBooks ||
					!btnMovies ||
					!booksContainer ||
					!moviesContainer
				) {
					return;
				}

				// Ëé∑ÂèñÂàùÂßãÊñáÊú¨
				const i18nTexts = {
					bookTitle: pageTitle?.textContent || "ÊàëÁöÑÈòÖËØªËÆ∞ÂΩï",
					bookSubtitle: "ËÆ∞ÂΩïÊàëÁöÑÈòÖËØª‰πãÊóÖ",
					movieTitle: "ÊàëÁöÑËßÇÂΩ±ËÆ∞ÂΩï",
					movieSubtitle: "ËÆ∞ÂΩïÊàëÁöÑÂÖâÂΩ±‰πãÊóÖ",
				};

				// Âº∫Âà∂ËÆæÁΩÆÂàùÂßãÁä∂ÊÄÅ - ÊòæÁ§∫‰π¶Á±çÔºåÈöêËóèÁîµÂΩ±
				booksContainer.style.display = "grid";
				moviesContainer.style.display = "none";
				booksContainer.classList.remove("hidden");
				moviesContainer.classList.add("hidden");
				bookFilters?.classList.remove("hidden");
				movieFilters?.classList.add("hidden");
				btnBooks.classList.add("media-type-active");
				btnMovies.classList.remove("media-type-active");

				btnBooks.addEventListener("click", function () {
					btnBooks.classList.add("media-type-active");
					btnMovies.classList.remove("media-type-active");
					booksContainer.style.display = "grid";
					moviesContainer.style.display = "none";
					booksContainer.classList.remove("hidden");
					moviesContainer.classList.add("hidden");
					bookFilters?.classList.remove("hidden");
					movieFilters?.classList.add("hidden");
					if (pageTitle) pageTitle.textContent = i18nTexts.bookTitle;
					if (pageSubtitle)
						pageSubtitle.textContent = i18nTexts.bookSubtitle;
				});

				btnMovies.addEventListener("click", function () {
					btnMovies.classList.add("media-type-active");
					btnBooks.classList.remove("media-type-active");
					moviesContainer.style.display = "grid";
					booksContainer.style.display = "none";
					moviesContainer.classList.remove("hidden");
					booksContainer.classList.add("hidden");
					movieFilters?.classList.remove("hidden");
					bookFilters?.classList.add("hidden");
					if (pageTitle) pageTitle.textContent = i18nTexts.movieTitle;
					if (pageSubtitle)
						pageSubtitle.textContent = i18nTexts.movieSubtitle;
				});

				initFilterButtons();
				initialized = true;
			}

			function initFilterButtons() {
				const filterContainers = document.querySelectorAll(
					".anime-filter-container",
				);
				filterContainers.forEach((container) => {
					const filterTags =
						container.querySelectorAll(".anime-filter-tag");
					const parentId = container.parentElement?.id;
					let listContainer;
					if (parentId === "book-filters") {
						listContainer =
							document.getElementById("books-container");
					} else if (parentId === "movie-filters") {
						listContainer =
							document.getElementById("movies-container");
					}
					if (!listContainer) return;

					filterTags.forEach((tag) => {
						tag.addEventListener("click", function () {
							if (this.classList.contains("anime-active")) return;
							filterTags.forEach((t) =>
								t.classList.remove("anime-active"),
							);
							this.classList.add("anime-active");
							const status = this.getAttribute("data-status");
							// ‰ΩøÁî® [data-anime-status] ÈÄâÊã©ÊâÄÊúâÈ°πÁõÆ
							const items = listContainer.querySelectorAll(
								"[data-anime-status]",
							);
							items.forEach((item) => {
								const itemStatus =
									item.getAttribute("data-anime-status");
								if (status === "all" || itemStatus === status) {
									item.classList.remove("anime-hidden");
								} else {
									item.classList.add("anime-hidden");
								}
							});
						});
					});
				});
			}

			if (document.readyState === "loading") {
				document.addEventListener("DOMContentLoaded", initMediaPage);
			} else {
				initMediaPage();
			}

			if (typeof window !== "undefined" && window.swup) {
				window.swup.hooks.on("content:replace", () =>
					setTimeout(initMediaPage, 150),
				);
			}

			// ÊáíÂä†ËΩΩÂäüËÉΩ - Â∑≤Á¶ÅÁî®
			function setupInfiniteScroll() {
				// ÊáíÂä†ËΩΩÂ∑≤Á¶ÅÁî®ÔºåÊâÄÊúâÂÜÖÂÆπÁõ¥Êé•ÊòæÁ§∫
			}

			// ÂàùÂßãÂåñÊáíÂä†ËΩΩ
			if (document.readyState === "loading") {
				document.addEventListener("DOMContentLoaded", () => {
					setupInfiniteScroll();
				});
			} else {
				setupInfiniteScroll();
			}

			// Âú®SwupÂØºËà™ÂêéÈáçÊñ∞ÂàùÂßãÂåñÊáíÂä†ËΩΩ
			if (typeof window !== "undefined" && window.swup) {
				window.swup.hooks.on("content:replace", () =>
					setTimeout(setupInfiniteScroll, 150),
				);
			}
		})();
	</script>
</MainGridLayout>
