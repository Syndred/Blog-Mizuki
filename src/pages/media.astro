---
import ImageWrapper from "../components/misc/ImageWrapper.astro";
import { siteConfig } from "../config";
import localBookList from "../data/books";
import localMovieList from "../data/movies";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";
import "../styles/anime.css";

if (!siteConfig.featurePages.books && !siteConfig.featurePages.movies) {
	return Astro.redirect("/404/");
}

function getBookStatusInfo(status: string) {
	switch (status) {
		case "reading":
			return {
				text: i18n(I18nKey.bookStatusReading),
				class: "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300",
				icon: "üìñ",
			};
		case "completed":
			return {
				text: i18n(I18nKey.bookStatusCompleted),
				class: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300",
				icon: "‚úì",
			};
		case "planned":
			return {
				text: i18n(I18nKey.bookStatusPlanned),
				class: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300",
				icon: "‚ù§",
			};
		default:
			return {
				text: status,
				class: "bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300",
				icon: "?",
			};
	}
}

function getMovieStatusInfo(status: string) {
	switch (status) {
		case "watched":
			return {
				text: i18n(I18nKey.movieStatusWatched),
				class: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300",
				icon: "‚úì",
			};
		case "watching":
			return {
				text: i18n(I18nKey.movieStatusWatching),
				class: "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300",
				icon: "‚ñ∂",
			};
		case "planned":
			return {
				text: i18n(I18nKey.movieStatusPlanned),
				class: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300",
				icon: "‚ù§",
			};
		default:
			return {
				text: status,
				class: "bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300",
				icon: "?",
			};
	}
}

// ÊáíÂä†ËΩΩÈÖçÁΩÆ
const INITIAL_DISPLAY_COUNT = 12;
const visibleBookList = localBookList.slice(0, INITIAL_DISPLAY_COUNT);
const hiddenBookList = localBookList.slice(INITIAL_DISPLAY_COUNT);
const visibleMovieList = localMovieList.slice(0, INITIAL_DISPLAY_COUNT);
const hiddenMovieList = localMovieList.slice(INITIAL_DISPLAY_COUNT);

// ËÆ°ÁÆóÂêÑÁä∂ÊÄÅÊï∞Èáè
const bookCounts = {
	all: localBookList.length,
	reading: localBookList.filter((b) => b.status === "reading").length,
	planned: localBookList.filter((b) => b.status === "planned").length,
	completed: localBookList.filter((b) => b.status === "completed").length,
};

const movieCounts = {
	all: localMovieList.length,
	watched: localMovieList.filter((m) => m.status === "watched").length,
	watching: localMovieList.filter((m) => m.status === "watching").length,
	planned: localMovieList.filter((m) => m.status === "planned").length,
};
---

<MainGridLayout title="ÊàëÁöÑ‰π¶ÂΩ±Èü≥" description="ËÆ∞ÂΩïÊàëÁöÑÈòÖËØª‰∏éËßÇÂΩ±‰πãÊóÖ">
	<div
		class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32"
	>
		<div class="card-base anime-card-base z-10 px-9 py-6 relative w-full">
			<div class="relative w-full mb-8">
				<div class="mb-6 flex justify-between items-start">
					<div>
						<h1
							class="text-4xl font-bold text-black/90 dark:text-white/90 mb-2 relative before:w-1 before:h-8 before:rounded-md before:bg-[var(--primary)] before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4"
							id="page-title"
						>
							{i18n(I18nKey.bookTitle)}
						</h1>
						<p
							class="text-black/75 dark:text-white/75"
							id="page-subtitle"
						>
							{i18n(I18nKey.bookSubtitle)}
						</p>
					</div>
					<div class="flex gap-2">
						<button
							id="btn-books"
							class="media-type-btn media-type-active px-4 py-2 rounded-lg font-medium transition-all flex items-center gap-2"
							data-type="books"
						>
							<span class="text-lg">üìö</span>
							<span>‰π¶Á±ç</span>
						</button>
						<button
							id="btn-movies"
							class="media-type-btn px-4 py-2 rounded-lg font-medium transition-all flex items-center gap-2"
							data-type="movies"
						>
							<span class="text-lg">üé¨</span>
							<span>ÁîµÂΩ±</span>
						</button>
					</div>
				</div>

				<div class="mb-6" id="book-filters">
					<div class="anime-filter-container flex flex-wrap gap-2">
						<button
							class="anime-filter-tag anime-active"
							data-status="all"
							>{i18n(I18nKey.bookFilterAll)} ({
								bookCounts.all
							})</button
						>
						<button class="anime-filter-tag" data-status="reading"
							>{i18n(I18nKey.bookStatusReading)} ({
								bookCounts.reading
							})</button
						>
						<button class="anime-filter-tag" data-status="planned"
							>{i18n(I18nKey.bookStatusPlanned)} ({
								bookCounts.planned
							})</button
						>
						<button class="anime-filter-tag" data-status="completed"
							>{i18n(I18nKey.bookStatusCompleted)} ({
								bookCounts.completed
							})</button
						>
					</div>
				</div>

				<div class="mb-6 hidden" id="movie-filters">
					<div class="anime-filter-container flex flex-wrap gap-2">
						<button
							class="anime-filter-tag anime-active"
							data-status="all"
							>{i18n(I18nKey.movieFilterAll)} ({
								movieCounts.all
							})</button
						>
						<button class="anime-filter-tag" data-status="watched"
							>{i18n(I18nKey.movieStatusWatched)} ({
								movieCounts.watched
							})</button
						>
						<button class="anime-filter-tag" data-status="watching"
							>{i18n(I18nKey.movieStatusWatching)} ({
								movieCounts.watching
							})</button
						>
						<button class="anime-filter-tag" data-status="planned"
							>{i18n(I18nKey.movieStatusPlanned)} ({
								movieCounts.planned
							})</button
						>
					</div>
				</div>
			</div>

			<div class="mb-8">
				<div
					id="books-container"
					class="anime-grid-container anime-list-mode grid gap-4 md:gap-6"
				>
					{
						visibleBookList.map((book) => {
							const statusInfo = getBookStatusInfo(book.status);
							const progressPercent =
								book.totalPages &&
								book.totalPages > 0 &&
								book.progress
									? (book.progress / book.totalPages) * 100
									: 0;
							return (
								<div
									class="group relative bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-[var(--radius-large)] overflow-hidden hover:shadow-lg transition-shadow book-item"
									data-anime-status={book.status}
								>
									<div class="relative anime-cover-container aspect-[2/3] overflow-hidden">
										<a
											href={`https://book.douban.com/subject/${book.doubanId}/`}
											target="_blank"
											rel="noopener noreferrer"
											class="block w-full h-full"
										>
											<ImageWrapper
												src="/assets/books/chongfan.jpg"
												alt="Book Cover"
												class="w-full h-full object-cover transition-transform duration-200 group-hover:scale-105"
											/>
										</a>
										<div
											class={`absolute top-2 left-2 px-2 py-1 rounded-md text-xs font-medium ${statusInfo.class}`}
										>
											<span class="mr-1">
												{statusInfo.icon}
											</span>
											<span>{statusInfo.text}</span>
										</div>
										{book.status === "reading" &&
											book.totalPages &&
											book.totalPages > 0 &&
											book.progress && (
												<div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2">
													<div class="w-full bg-white/20 rounded-full h-1.5 mb-1">
														<div
															class="bg-gradient-to-r from-emerald-400 to-teal-400 h-1.5 rounded-full transition-all duration-300"
															style={`width: ${progressPercent}%`}
														/>
													</div>
													<div class="text-white text-xs font-medium">
														{book.progress}/
														{book.totalPages} È°µ (
														{Math.round(
															progressPercent,
														)}
														%)
													</div>
												</div>
											)}
									</div>
									<div class="p-3">
										<h3 class="text-sm font-bold text-black/90 dark:text-white/90 mb-1 leading-tight line-clamp-2">
											{book.title ||
												`Ë±ÜÁì£ID: ${book.doubanId}`}
										</h3>
										{book.author && (
											<p class="text-black/60 dark:text-white/60 text-xs mb-2">
												{book.author}
											</p>
										)}
										{book.rating && (
											<div class="flex items-center gap-1 text-xs text-amber-500">
												<span>‚≠ê</span>
												<span>{book.rating}</span>
											</div>
										)}
									</div>
								</div>
							);
						})
					}
				</div>

				<!-- ‰π¶Á±çÊáíÂä†ËΩΩÊ®°Êùø -->
				<template id="books-lazy-store">
					{
						hiddenBookList.map((book) => {
							const statusInfo = getBookStatusInfo(book.status);
							const progressPercent =
								book.totalPages &&
								book.totalPages > 0 &&
								book.progress
									? (book.progress / book.totalPages) * 100
									: 0;
							return (
								<div
									class="group relative bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-[var(--radius-large)] overflow-hidden hover:shadow-lg transition-shadow initial-hidden book-item"
									data-anime-status={book.status}
								>
									<div class="relative anime-cover-container aspect-[2/3] overflow-hidden">
										<a
											href={`https://book.douban.com/subject/${book.doubanId}/`}
											target="_blank"
											rel="noopener noreferrer"
											class="block w-full h-full"
										>
											<ImageWrapper
												src="/assets/books/chongfan.jpg"
												alt="Book Cover"
												class="w-full h-full object-cover transition-transform duration-200 group-hover:scale-105"
											/>
										</a>
										<div
											class={`absolute top-2 left-2 px-2 py-1 rounded-md text-xs font-medium ${statusInfo.class}`}
										>
											<span class="mr-1">
												{statusInfo.icon}
											</span>
											<span>{statusInfo.text}</span>
										</div>
										{book.status === "reading" &&
											book.totalPages &&
											book.totalPages > 0 &&
											book.progress && (
												<div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2">
													<div class="w-full bg-white/20 rounded-full h-1.5 mb-1">
														<div
															class="bg-gradient-to-r from-emerald-400 to-teal-400 h-1.5 rounded-full transition-all duration-300"
															style={`width: ${progressPercent}%`}
														/>
													</div>
													<div class="text-white text-xs font-medium">
														{book.progress}/
														{book.totalPages} È°µ (
														{Math.round(
															progressPercent,
														)}
														%)
													</div>
												</div>
											)}
									</div>
									<div class="p-3">
										<h3 class="text-sm font-bold text-black/90 dark:text-white/90 mb-1 leading-tight line-clamp-2">
											{book.title ||
												`Ë±ÜÁì£ID: ${book.doubanId}`}
										</h3>
										{book.author && (
											<p class="text-black/60 dark:text-white/60 text-xs mb-2">
												{book.author}
											</p>
										)}
										{book.rating && (
											<div class="flex items-center gap-1 text-xs text-amber-500">
												<span>‚≠ê</span>
												<span>{book.rating}</span>
											</div>
										)}
									</div>
								</div>
							);
						})
					}
				</template>

				{
					hiddenBookList.length > 0 && (
						<div
							id="books-scroll-sentinel"
							class="w-full h-20 flex items-center justify-center mt-8 book-sentinel"
						>
							<div class="anime-loading-spinner w-8 h-8 border-4 border-[var(--primary)] border-t-transparent rounded-full animate-spin" />
						</div>
					)
				}

				<div
					id="movies-container"
					class="anime-grid-container anime-list-mode grid gap-4 md:gap-6 hidden"
				>
					{
						visibleMovieList.map((movie) => {
							const statusInfo = getMovieStatusInfo(movie.status);
							return (
								<div
									class="group relative bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-[var(--radius-large)] overflow-hidden hover:shadow-lg transition-shadow movie-item"
									data-anime-status={movie.status}
								>
									<div class="relative anime-cover-container aspect-[2/3] overflow-hidden">
										<a
											href={`https://movie.douban.com/subject/${movie.doubanId}/`}
											target="_blank"
											rel="noopener noreferrer"
											class="block w-full h-full"
										>
											<ImageWrapper
												src="/assets/movies/Interstellar.webp"
												alt="Movie Poster"
												class="w-full h-full object-cover transition-transform duration-200 group-hover:scale-105"
											/>
										</a>
										<div
											class={`absolute top-2 left-2 px-2 py-1 rounded-md text-xs font-medium ${statusInfo.class}`}
										>
											<span class="mr-1">
												{statusInfo.icon}
											</span>
											<span>{statusInfo.text}</span>
										</div>
									</div>
									<div class="p-3">
										<h3 class="text-sm font-bold text-black/90 dark:text-white/90 mb-1 leading-tight line-clamp-2">
											{movie.title ||
												`Ë±ÜÁì£ID: ${movie.doubanId}`}
										</h3>
										{movie.director && (
											<p class="text-black/60 dark:text-white/60 text-xs mb-2">
												{movie.director}
											</p>
										)}
										<div class="flex items-center justify-between">
											{movie.rating && (
												<div class="flex items-center gap-1 text-xs text-amber-500">
													<span>‚≠ê</span>
													<span>{movie.rating}</span>
												</div>
											)}
											{movie.year && (
												<span class="text-xs text-black/50 dark:text-white/50">
													{movie.year}
												</span>
											)}
										</div>
									</div>
								</div>
							);
						})
					}
				</div>

				<!-- ÁîµÂΩ±ÊáíÂä†ËΩΩÊ®°Êùø -->
				<template id="movies-lazy-store">
					{
						hiddenMovieList.map((movie) => {
							const statusInfo = getMovieStatusInfo(movie.status);
							return (
								<div
									class="group relative bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-[var(--radius-large)] overflow-hidden hover:shadow-lg transition-shadow initial-hidden movie-item"
									data-anime-status={movie.status}
								>
									<div class="relative anime-cover-container aspect-[2/3] overflow-hidden">
										<a
											href={`https://movie.douban.com/subject/${movie.doubanId}/`}
											target="_blank"
											rel="noopener noreferrer"
											class="block w-full h-full"
										>
											<ImageWrapper
												src="/assets/movies/Interstellar.webp"
												alt="Movie Poster"
												class="w-full h-full object-cover transition-transform duration-200 group-hover:scale-105"
											/>
										</a>
										<div
											class={`absolute top-2 left-2 px-2 py-1 rounded-md text-xs font-medium ${statusInfo.class}`}
										>
											<span class="mr-1">
												{statusInfo.icon}
											</span>
											<span>{statusInfo.text}</span>
										</div>
									</div>
									<div class="p-3">
										<h3 class="text-sm font-bold text-black/90 dark:text-white/90 mb-1 leading-tight line-clamp-2">
											{movie.title ||
												`Ë±ÜÁì£ID: ${movie.doubanId}`}
										</h3>
										{movie.director && (
											<p class="text-black/60 dark:text-white/60 text-xs mb-2">
												{movie.director}
											</p>
										)}
										<div class="flex items-center justify-between">
											{movie.rating && (
												<div class="flex items-center gap-1 text-xs text-amber-500">
													<span>‚≠ê</span>
													<span>{movie.rating}</span>
												</div>
											)}
											{movie.year && (
												<span class="text-xs text-black/50 dark:text-white/50">
													{movie.year}
												</span>
											)}
										</div>
									</div>
								</div>
							);
						})
					}
				</template>

				{
					hiddenMovieList.length > 0 && (
						<div
							id="movies-scroll-sentinel"
							class="w-full h-20 flex items-center justify-center mt-8 hidden movie-sentinel"
						>
							<div class="anime-loading-spinner w-8 h-8 border-4 border-[var(--primary)] border-t-transparent rounded-full animate-spin" />
						</div>
					)
				}
			</div>
		</div>
	</div>

	<style>
		.media-type-btn {
			background: var(--btn-regular-bg);
			color: var(--btn-content);
			border: 1px solid var(--line-divider);
		}
		.media-type-btn:hover:not(.media-type-active) {
			background: var(--btn-hover-bg);
			border-color: var(--primary);
			transform: translateY(-1px);
		}
		.media-type-btn.media-type-active {
			background: var(--primary);
			color: white;
			border-color: var(--primary);
		}
	</style>

	<script is:inline>
		(function () {
			const i18nTexts = {
				bookTitle:
					document.getElementById("page-title")?.textContent ||
					"ÊàëÁöÑÈòÖËØªËÆ∞ÂΩï",
				bookSubtitle: "ËÆ∞ÂΩïÊàëÁöÑÈòÖËØª‰πãÊóÖ",
				movieTitle: "ÊàëÁöÑËßÇÂΩ±ËÆ∞ÂΩï",
				movieSubtitle: "ËÆ∞ÂΩïÊàëÁöÑÂÖâÂΩ±‰πãÊóÖ",
			};

			function initMediaPage() {
				const btnBooks = document.getElementById("btn-books");
				const btnMovies = document.getElementById("btn-movies");
				const booksContainer =
					document.getElementById("books-container");
				const moviesContainer =
					document.getElementById("movies-container");
				const bookFilters = document.getElementById("book-filters");
				const movieFilters = document.getElementById("movie-filters");
				const pageTitle = document.getElementById("page-title");
				const pageSubtitle = document.getElementById("page-subtitle");

				if (
					!btnBooks ||
					!btnMovies ||
					!booksContainer ||
					!moviesContainer
				)
					return;

				const booksSentinel = document.getElementById(
					"books-scroll-sentinel",
				);
				const moviesSentinel = document.getElementById(
					"movies-scroll-sentinel",
				);

				btnBooks.addEventListener("click", () => {
					btnBooks.classList.add("media-type-active");
					btnMovies.classList.remove("media-type-active");
					booksContainer.classList.remove("hidden");
					moviesContainer.classList.add("hidden");
					bookFilters?.classList.remove("hidden");
					movieFilters?.classList.add("hidden");
					if (booksSentinel) booksSentinel.classList.remove("hidden");
					if (moviesSentinel) moviesSentinel.classList.add("hidden");
					if (pageTitle) pageTitle.textContent = i18nTexts.bookTitle;
					if (pageSubtitle)
						pageSubtitle.textContent = i18nTexts.bookSubtitle;
				});

				btnMovies.addEventListener("click", () => {
					btnMovies.classList.add("media-type-active");
					btnBooks.classList.remove("media-type-active");
					moviesContainer.classList.remove("hidden");
					booksContainer.classList.add("hidden");
					movieFilters?.classList.remove("hidden");
					bookFilters?.classList.add("hidden");
					if (moviesSentinel)
						moviesSentinel.classList.remove("hidden");
					if (booksSentinel) booksSentinel.classList.add("hidden");
					if (pageTitle) pageTitle.textContent = i18nTexts.movieTitle;
					if (pageSubtitle)
						pageSubtitle.textContent = i18nTexts.movieSubtitle;
				});

				initFilterButtons();
			}

			function initFilterButtons() {
				const filterContainers = document.querySelectorAll(
					".anime-filter-container",
				);
				filterContainers.forEach((container) => {
					const filterTags =
						container.querySelectorAll(".anime-filter-tag");
					const parentId = container.parentElement?.id;
					let listContainer;
					if (parentId === "book-filters") {
						listContainer =
							document.getElementById("books-container");
					} else if (parentId === "movie-filters") {
						listContainer =
							document.getElementById("movies-container");
					}
					if (!listContainer) return;

					filterTags.forEach((tag) => {
						tag.addEventListener("click", function () {
							if (this.classList.contains("anime-active")) return;
							filterTags.forEach((t) =>
								t.classList.remove("anime-active"),
							);
							this.classList.add("anime-active");
							const status = this.getAttribute("data-status");
							// ‰ΩøÁî® [data-anime-status] ÈÄâÊã©ÊâÄÊúâÈ°πÁõÆ
							const items = listContainer.querySelectorAll(
								"[data-anime-status]",
							);
							items.forEach((item) => {
								const itemStatus =
									item.getAttribute("data-anime-status");
								if (status === "all" || itemStatus === status) {
									item.classList.remove("anime-hidden");
								} else {
									item.classList.add("anime-hidden");
								}
							});
						});
					});
				});
			}

			if (document.readyState === "loading") {
				document.addEventListener("DOMContentLoaded", initMediaPage);
			} else {
				initMediaPage();
			}

			if (typeof window !== "undefined" && window.swup) {
				window.swup.hooks.on("content:replace", () =>
					setTimeout(initMediaPage, 150),
				);
			}

			// ÊáíÂä†ËΩΩÂäüËÉΩ
			function setupInfiniteScroll() {
				const booksSentinel = document.getElementById(
					"books-scroll-sentinel",
				);
				const moviesSentinel = document.getElementById(
					"movies-scroll-sentinel",
				);
				const booksContainer =
					document.getElementById("books-container");
				const moviesContainer =
					document.getElementById("movies-container");
				const booksLazyStore =
					document.getElementById("books-lazy-store");
				const moviesLazyStore =
					document.getElementById("movies-lazy-store");

				if (!booksContainer || !moviesContainer) return;

				const observerOptions = {
					root: null,
					rootMargin: "100px",
					threshold: 0.1,
				};

				// Ëé∑ÂèñÂΩìÂâçÊøÄÊ¥ªÁöÑÁ≠õÈÄâÁä∂ÊÄÅ
				function getActiveFilter(containerId) {
					const filterContainer =
						containerId === "books-container"
							? document.getElementById("book-filters")
							: document.getElementById("movie-filters");
					if (!filterContainer) return "all";
					const activeTag = filterContainer.querySelector(
						".anime-filter-tag.anime-active",
					);
					return activeTag
						? activeTag.getAttribute("data-status")
						: "all";
				}

				// ‰π¶Á±çÊáíÂä†ËΩΩ
				if (
					booksSentinel &&
					booksLazyStore &&
					booksLazyStore.content.children.length > 0
				) {
					const booksObserver = new IntersectionObserver(
						(entries) => {
							entries.forEach((entry) => {
								if (entry.isIntersecting) {
									const fragment =
										document.createDocumentFragment();
									const activeStatus =
										getActiveFilter("books-container");

									// ‰ΩøÁî® children ËÄå‰∏çÊòØ childNodes Êù•ÈÅøÂÖçÊñáÊú¨ËäÇÁÇπ
									const nodes = Array.from(
										booksLazyStore.content.children,
									);
									nodes.forEach((node) => {
										// Ê†πÊçÆÂΩìÂâçÁ≠õÈÄâÁä∂ÊÄÅÂÜ≥ÂÆöÊòØÂê¶ÈöêËóè
										if (activeStatus !== "all") {
											const itemStatus =
												node.getAttribute(
													"data-anime-status",
												);
											if (itemStatus !== activeStatus) {
												node.classList.add(
													"anime-hidden",
												);
											}
										}
										fragment.appendChild(node);
									});
									booksContainer.appendChild(fragment);
									booksSentinel.style.display = "none";
									booksObserver.disconnect();
								}
							});
						},
						observerOptions,
					);
					booksObserver.observe(booksSentinel);
				}

				// ÁîµÂΩ±ÊáíÂä†ËΩΩ
				if (
					moviesSentinel &&
					moviesLazyStore &&
					moviesLazyStore.content.children.length > 0
				) {
					const moviesObserver = new IntersectionObserver(
						(entries) => {
							entries.forEach((entry) => {
								if (entry.isIntersecting) {
									const fragment =
										document.createDocumentFragment();
									const activeStatus =
										getActiveFilter("movies-container");

									// ‰ΩøÁî® children ËÄå‰∏çÊòØ childNodes Êù•ÈÅøÂÖçÊñáÊú¨ËäÇÁÇπ
									const nodes = Array.from(
										moviesLazyStore.content.children,
									);
									nodes.forEach((node) => {
										// Ê†πÊçÆÂΩìÂâçÁ≠õÈÄâÁä∂ÊÄÅÂÜ≥ÂÆöÊòØÂê¶ÈöêËóè
										if (activeStatus !== "all") {
											const itemStatus =
												node.getAttribute(
													"data-anime-status",
												);
											if (itemStatus !== activeStatus) {
												node.classList.add(
													"anime-hidden",
												);
											}
										}
										fragment.appendChild(node);
									});
									moviesContainer.appendChild(fragment);
									moviesSentinel.style.display = "none";
									moviesObserver.disconnect();
								}
							});
						},
						observerOptions,
					);
					moviesObserver.observe(moviesSentinel);
				}
			}

			// ÂàùÂßãÂåñÊáíÂä†ËΩΩ
			if (document.readyState === "loading") {
				document.addEventListener("DOMContentLoaded", () => {
					setupInfiniteScroll();
				});
			} else {
				setupInfiniteScroll();
			}

			// Âú®SwupÂØºËà™ÂêéÈáçÊñ∞ÂàùÂßãÂåñÊáíÂä†ËΩΩ
			if (typeof window !== "undefined" && window.swup) {
				window.swup.hooks.on("content:replace", () =>
					setTimeout(setupInfiniteScroll, 150),
				);
			}
		})();
	</script>
</MainGridLayout>
